name: Show All Workflow Runs

on:
  push:
    branches:
      - main

jobs:
  show-all-runs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: List all workflow YAML files
        run: |
          echo "===== Workflows in .github/workflows ====="
          ls -1 .github/workflows

      - name: List all local actions (if any)
        run: |
          echo "===== Local Actions in .github/actions ====="
          if [ -d ".github/actions" ]; then
            ls -R .github/actions
          else
            echo "No local actions found."
          fi

      - name: Show all workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const perPage = 100; // عدد أكبر للحصول على كل الـ runs
            let page = 1;
            let allRuns = [];

            while (true) {
              const response = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: perPage,
                page: page
              });
              
              allRuns = allRuns.concat(response.data.workflow_runs);
              
              if (response.data.workflow_runs.length < perPage) break;
              page++;
            }

            console.log(`===== Total Workflow Runs: ${allRuns.length} =====`);
            allRuns.forEach(run => {
              console.log(`Workflow: ${run.name} | Status: ${run.status} | Conclusion: ${run.conclusion} | Run ID: ${run.id}`);
            });

            // مثال فلترة: إظهار بس الـ failed runs
            const failedRuns = allRuns.filter(run => run.conclusion === 'failure');
            console.log(`===== Failed Runs: ${failedRuns.length} =====`);
            failedRuns.forEach(run => {
              console.log(`FAILED -> Workflow: ${run.name} | Run ID: ${run.id}`);
            });
